generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
}

/**
 * =========================
 * ENUMS (Dominio)
 * =========================
 */

enum ClinicRole {
  OWNER
  ADMIN
  VET
  RECEPTION
}

enum PetSpecies {
  DOG
  CAT
  BIRD
  RABBIT
  OTHER
}

enum PetSex {
  MALE
  FEMALE
  UNKNOWN
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  VOID
}

enum InvoiceItemType {
  SERVICE
  PRODUCT
  CUSTOM
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  OTHER
}

enum StockMovementType {
  IN
  OUT
  ADJUST
  SALE
  PURCHASE
  EXPIRED
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  WHATSAPP
}

enum NotificationStatus {
  QUEUED
  SENT
  FAILED
  CANCELLED
}

enum VaccineIntervalUnit {
  DAYS
  WEEKS
  MONTHS
  YEARS
}

enum AppointmentType {
  CONSULTATION
  VACCINATION
  SURGERY
  AESTHETIC
  CHECKUP
  EMERGENCY
  GROOMING
  DEWORMING
  OTHER
}

/**
 * =========================
 * BETTER AUTH
 * =========================
 */

model User {
  id            String    @id
  name          String    @db.Text
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]

  // relaciones del dominio (no agregan columnas nuevas aquí)
  memberships     ClinicMember[]
  vetAppointments Appointment[]   @relation("AppointmentVet")
  createdInvoices Invoice[]       @relation("InvoiceCreatedBy")
  createdPayments Payment[]       @relation("PaymentCreatedBy")
  stockMovements  StockMovement[] @relation("StockMovementCreatedBy")
  clinicalVisits  ClinicalVisit[] @relation("ClinicalVisitVet")

  notificationRecipients NotificationRecipient[]
  createdNotifications   Notification[] @relation("NotificationCreatedBy")

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?  @db.Text
  userAgent String?  @db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String    @db.Text
  providerId            String    @db.Text
  userId                String
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?   @db.Text
  password              String?   @db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String   @db.Text
  value      String   @db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier(length: 191)])
  @@map("verification")
}

/**
 * =========================
 * CORE (Clínica + membresía)
 * =========================
 */

model Clinic {
  id       Int     @id @default(autoincrement())
  name     String
  phone    String?
  email    String?
  address  String?
  currency String  @default("USD")
  timezone String  @default("America/Santo_Domingo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members            ClinicMember[]
  clients            Client[]
  pets               Pet[]
  appointments       Appointment[]
  services           Service[]
  products           Product[]
  invoices           Invoice[]
  visits             ClinicalVisit[]
  vaccines           VaccineCatalog[]
  vaccinations       VaccinationRecord[]
  notifications      Notification[]
  stockMovements     StockMovement[]
  medicalAttachments MedicalAttachment[]

  @@index([createdAt])
}

model ClinicMember {
  id       Int        @id @default(autoincrement())
  clinicId Int
  userId   String
  role     ClinicRole @default(ADMIN)
  isActive Boolean    @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clinicId, userId])
  @@index([clinicId])
  @@index([userId])
  @@index([clinicId, role])
}

/**
 * =========================
 * CLIENTES / PETS
 * =========================
 */

model Client {
  id       Int     @id @default(autoincrement())
  clinicId Int
  fullName String
  phone    String?
  email    String?
  address  String?
  notes    String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  pets         Pet[]
  appointments Appointment[]
  invoices     Invoice[]
  visits       ClinicalVisit[]

  notificationRecipients NotificationRecipient[]

  @@index([clinicId])
  @@index([clinicId, fullName])
  @@index([clinicId, phone])
  @@index([clinicId, email])
}

model Pet {
  id       Int @id @default(autoincrement())
  clinicId Int
  clientId Int

  name      String
  species   PetSpecies
  breed     String?
  sex       PetSex     @default(UNKNOWN)
  color     String?
  birthDate DateTime?
  microchip String?
  weightKg  Float?
  notes     String?    @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  appointments Appointment[]
  visits       ClinicalVisit[]
  vaccinations VaccinationRecord[]
  invoices     Invoice[]

  @@unique([clinicId, microchip])
  @@index([clinicId])
  @@index([clientId])
  @@index([clinicId, name])
}

/**
 * =========================
 * AGENDA / CITAS
 * =========================
 */

model Appointment {
  id       Int @id @default(autoincrement())
  clinicId Int
  clientId Int
  petId    Int

  type   AppointmentType    @default(CONSULTATION)

  startAt DateTime
  endAt   DateTime?
  status  AppointmentStatus @default(SCHEDULED)

  reason String?
  notes  String? @db.Text

  // veterinario asignado (User es String)
  vetId String?
  vet   User? @relation("AppointmentVet", fields: [vetId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  pet    Pet    @relation(fields: [petId], references: [id], onDelete: Cascade)

  visit   ClinicalVisit?
  invoice Invoice?

  @@index([clinicId, startAt])
  @@index([clinicId, status])
  @@index([clinicId, type])
  @@index([petId])
  @@index([clientId])
  @@index([vetId])
}

/**
 * =========================
 * SERVICIOS
 * =========================
 */

model Service {
  id           Int @id @default(autoincrement())
  clinicId     Int
  name         String
  description  String? @db.Text
  durationMins Int?
  price        Decimal @db.Decimal(12, 2)
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic       Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  invoiceItems InvoiceItem[]

  @@unique([clinicId, name])
  @@index([clinicId, isActive])
}

/**
 * =========================
 * INVENTARIO
 * =========================
 */

model Product {
  id       Int @id @default(autoincrement())
  clinicId Int

  sku      String?
  name     String
  category String?
  unit     String?

  cost  Decimal? @db.Decimal(12, 2)
  price Decimal? @db.Decimal(12, 2)

  trackStock  Boolean @default(true)
  stockOnHand Int     @default(0)
  minStock    Int     @default(0)

  isActive Boolean @default(true)

  description          String?  @db.Text
  requiresPrescription Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  stockMovements StockMovement[]
  invoiceItems   InvoiceItem[]

  @@unique([clinicId, sku])
  @@index([clinicId, isActive])
  @@index([clinicId, stockOnHand])
  @@index([clinicId, minStock])
}

model StockMovement {
  id        Int @id @default(autoincrement())
  clinicId  Int
  productId Int
  type      StockMovementType

  quantity      Int
  reason        String?
  referenceType String?
  referenceId   String?

  createdById String?
  createdBy   User? @relation("StockMovementCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  clinic  Clinic  @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([clinicId, createdAt])
  @@index([productId])
  @@index([createdById])
}

/**
 * =========================
 * FACTURACIÓN
 * =========================
 */

model Invoice {
  id       Int @id @default(autoincrement())
  clinicId Int
  clientId Int

  petId         Int?
  appointmentId Int? @unique

  number String
  status InvoiceStatus @default(ISSUED)

  issueDate DateTime @default(now())
  dueDate   DateTime?
  paidAt    DateTime?

  subtotal Decimal @default(0.00) @db.Decimal(12, 2)
  tax      Decimal @default(0.00) @db.Decimal(12, 2)
  discount Decimal @default(0.00) @db.Decimal(12, 2)
  total    Decimal @default(0.00) @db.Decimal(12, 2)

  notes String? @db.Text

  createdById String?
  createdBy   User? @relation("InvoiceCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic      Clinic       @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  client      Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  pet         Pet?         @relation(fields: [petId], references: [id], onDelete: SetNull)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  items    InvoiceItem[]
  payments Payment[]

  @@unique([clinicId, number])
  @@index([clinicId, issueDate])
  @@index([clinicId, createdAt])
  @@index([clinicId, status])
  @@index([clientId])
}

model InvoiceItem {
  id        Int @id @default(autoincrement())
  invoiceId Int
  type      InvoiceItemType

  serviceId Int?
  productId Int?

  description String
  quantity    Decimal @default(1.00) @db.Decimal(12, 2)
  unitPrice   Decimal @default(0.00) @db.Decimal(12, 2)
  taxRate     Decimal @default(0.00) @db.Decimal(5, 2)
  lineTotal   Decimal @default(0.00) @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@index([serviceId])
  @@index([productId])
}

model Payment {
  id        Int @id @default(autoincrement())
  invoiceId Int
  amount    Decimal       @db.Decimal(12, 2)
  method    PaymentMethod @default(CASH)
  reference String?

  paidAt DateTime @default(now())

  createdById String?
  createdBy   User? @relation("PaymentCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([paidAt])
  @@index([createdById])
}

/**
 * =========================
 * HISTORIAL CLÍNICO + VACUNAS
 * =========================
 */

model ClinicalVisit {
  id       Int @id @default(autoincrement())
  clinicId Int
  clientId Int
  petId    Int

  appointmentId Int? @unique
  vetId         String?

  visitAt      DateTime @default(now())
  weightKg     Float?
  temperatureC Float?

  diagnosis String? @db.Text
  treatment String? @db.Text
  notes     String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic      Clinic       @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  client      Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  pet         Pet          @relation(fields: [petId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  vet         User?        @relation("ClinicalVisitVet", fields: [vetId], references: [id], onDelete: SetNull)

  attachments  MedicalAttachment[]
  vaccinations VaccinationRecord[]

  @@index([clinicId, visitAt])
  @@index([petId])
  @@index([clientId])
  @@index([vetId])
}

model MedicalAttachment {
  id       Int @id @default(autoincrement())
  clinicId Int
  visitId  Int

  fileName String
  fileType String?
  url      String @db.Text

  createdAt DateTime @default(now())

  clinic Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  visit  ClinicalVisit @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@index([visitId])
  @@index([clinicId, createdAt])
}

model VaccineCatalog {
  id       Int @id @default(autoincrement())
  clinicId Int

  name    String
  species PetSpecies?

  intervalValue Int?
  intervalUnit  VaccineIntervalUnit?

  notes    String? @db.Text
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic  Clinic              @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  records VaccinationRecord[]

  @@unique([clinicId, name])
  @@index([clinicId, isActive])
}

model VaccinationRecord {
  id        Int @id @default(autoincrement())
  clinicId  Int
  petId     Int
  vaccineId Int

  visitId   Int?
  appliedAt DateTime  @default(now())
  nextDueAt DateTime?

  batchNumber String?
  notes       String? @db.Text

  createdAt DateTime @default(now())

  clinic  Clinic         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  pet     Pet            @relation(fields: [petId], references: [id], onDelete: Cascade)
  vaccine VaccineCatalog @relation(fields: [vaccineId], references: [id], onDelete: Cascade)
  visit   ClinicalVisit? @relation(fields: [visitId], references: [id], onDelete: SetNull)

  @@index([clinicId, nextDueAt])
  @@index([petId])
  @@index([vaccineId])
}

/**
 * =========================
 * NOTIFICACIONES (log)
 * =========================
 */

model Notification {
  id       Int @id @default(autoincrement())
  clinicId Int

  channel NotificationChannel
  status  NotificationStatus @default(QUEUED)

  title   String
  message String @db.Text

  scheduledAt DateTime?
  sentAt      DateTime?
  error       String? @db.Text

  meta Json?

  createdById String?
  createdBy   User? @relation("NotificationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  clinic     Clinic                  @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  recipients NotificationRecipient[]

  @@index([clinicId, createdAt])
  @@index([clinicId, status])
  @@index([scheduledAt])
  @@index([createdById])
}

model NotificationRecipient {
  id             Int @id @default(autoincrement())
  notificationId Int

  userId   String?
  clientId Int?

  email String?
  phone String?

  status NotificationStatus @default(QUEUED)
  sentAt DateTime?
  error  String? @db.Text

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  client       Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([notificationId])
  @@index([userId])
  @@index([clientId])
}
